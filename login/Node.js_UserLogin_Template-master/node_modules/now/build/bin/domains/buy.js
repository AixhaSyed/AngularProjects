const { italic, bold } = require('chalk')

const error = require('../../lib/utils/output/error')
const wait = require('../../lib/utils/output/wait')
const cmd = require('../../lib/utils/output/cmd')
const param = require('../../lib/utils/output/param')
const info = require('../../lib/utils/output/info')
const uid = require('../../lib/utils/output/uid')
const success = require('../../lib/utils/output/success')
const stamp = require('../../lib/utils/output/stamp')
const promptBool = require('../../lib/utils/input/prompt-bool')
const eraseLines = require('../../lib/utils/output/erase-lines')
const treatBuyError = require('../../lib/utils/domains/treat-buy-error')

module.exports = function({ domains, args, currentTeam, user }) {return __async(function*(){
  const name = args[0]
  let elapsed

  if (!name) {
    return error(`Missing domain name. Run ${cmd('now domains help')}`)
  }

  const nameParam = param(name)
  elapsed = stamp()
  let stopSpinner = wait(`Checking availability for ${nameParam}`)

  const price = yield domains.price(name)
  const available = yield domains.status(name)

  stopSpinner()

  if (!available) {
    return error(
      `The domain ${nameParam} is ${italic('unavailable')}! ${elapsed()}`
    )
  }

  info(`The domain ${nameParam} is ${italic('available')}! ${elapsed()}`)
  const confirmation = yield promptBool(
    `Buy now for ${bold(`$${price}`)} (${bold((currentTeam && currentTeam.slug) || user.username || user.email)})?`
  )

  eraseLines(1)
  if (!confirmation) {
    return info('Aborted')
  }

  stopSpinner = wait('Purchasing')
  elapsed = stamp()
  let domain
  try {
    domain = yield domains.buy(name)
  } catch (err) {
    stopSpinner()
    return treatBuyError(err)
  }

  stopSpinner()

  success(`Domain purchased and created ${uid(domain.uid)} ${elapsed()}`)
  info(
    `You may now use your domain as an alias to your deployments. Run ${cmd('now alias help')}`
  )
}())}

function __async(g){return new Promise(function(s,j){function c(a,x){try{var r=g[x?"throw":"next"](a)}catch(e){j(e);return}r.done?s(r.value):Promise.resolve(r.value).then(c,d)}function d(e){c(e,1)}c()})}
